<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNO Online - Duduxindev</title>
    
    <!-- Loading styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/cards-fixed.css">
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/menu.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/uno-master-fix.css">
    <link rel="stylesheet" href="css/emergency-fix.css">
    <link rel="stylesheet" href="css/cards-visibility-fix.css">
    <link rel="stylesheet" href="css/enhanced-cards.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update, get } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
        
        // Updated configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlYzl1Kzd5pY0gZYRghsrGkbCfLm6iTqk",
            authDomain: "uno-game-duduxindev.firebaseapp.com",
            databaseURL: "https://uno-game-duduxindev-default-rtdb.firebaseio.com",
            projectId: "uno-game-duduxindev",
            storageBucket: "uno-game-duduxindev.firebasestorage.app",
            messagingSenderId: "1020680045987",
            appId: "1:1020680045987:web:f8e762882f180fd6b9c616",
            measurementId: "G-HYKE1R16G5"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        
        // Expose for non-modular scripts
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseAnalytics = analytics;
        
        console.log("✅ Firebase Modular initialized successfully!");
    </script>
    
    <!-- Firebase compat for compatibility with existing code -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics-compat.js"></script>
    
    <script>
        // Initialize compatibility API
        firebase.initializeApp({
            apiKey: "AIzaSyBlYzl1Kzd5pY0gZYRghsrGkbCfLm6iTqk",
            authDomain: "uno-game-duduxindev.firebaseapp.com",
            databaseURL: "https://uno-game-duduxindev-default-rtdb.firebaseio.com",
            projectId: "uno-game-duduxindev",
            storageBucket: "uno-game-duduxindev.firebasestorage.app",
            messagingSenderId: "1020680045987",
            appId: "1:1020680045987:web:f8e762882f180fd6b9c616",
            measurementId: "G-HYKE1R16G5"
        });
        
        console.log("✅ Firebase Compat initialized successfully!");
    </script>
</head>
<body>
    <script>
    console.log("🚨 Applying emergency fix: 2025-04-14 14:34:10");
    </script>
    
    <!-- Content of the page remains the same, only updating versions and loading new scripts -->
    
    <!-- Firebase Scripts - Same as before -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-reconnect.js"></script>
    <script src="js/firebase-auth.js"></script>
    <script src="js/firebase-database.js"></script>
    <script src="js/firebase-storage.js"></script>
    <script src="js/firebase-presence.js"></script>
    
    <!-- Application scripts -->
    <script src="js/storage.js"></script>
    <script src="js/player.js"></script>
    <script src="js/card-generator.js"></script> <!-- New script for card generation -->
    <script src="js/enhanced-modes.js"></script> <!-- Enhanced game modes -->
    <script src="js/enhanced-card-renderer.js"></script> <!-- Enhanced card renderer -->
    <script src="js/room.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/game-starter.js"></script>
    <script src="js/game-initializer.js"></script>
    <script src="js/ai-player.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
    <script src="js/uno-master-fix.js"></script>
    <script src="js/firebase-direct-fix.js"></script>
    <script src="js/cards-direct-fix.js"></script>
    
    <!-- Script for initialization -->
    <script>
                console.log("Initializing UNO application on: 2025-04-14 14:41:01");
        console.log("Developer: Duduxindev");
        
        // Check if all scripts were loaded correctly
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded");
            
            // Add pulsation animation to the start game button
            const pulseButton = document.querySelector('.pulse-button');
            if (pulseButton) {
                setInterval(() => {
                    pulseButton.classList.toggle('pulse');
                }, 1500);
            }
            
            // Initialize anonymous authentication automatically
            if (window.FirebaseAuth) {
                FirebaseAuth.signInAnonymously()
                  .then(user => {
                    console.log("✅ Authenticated as:", user.uid);
                    
                    // Initialize presence system
                    if (window.FirebasePresence) {
                        FirebasePresence.init(user.uid, Storage.getSession().playerName || "Jogador");
                    }
                  })
                  .catch(error => {
                    console.error("❌ Authentication error:", error);
                  });
            }
            
            // Check for enhanced systems
            setTimeout(function() {
                console.log("🔍 Checking for enhanced systems...");
                
                // Check if enhanced systems are working
                if (!window.cardGenerator) {
                    console.error("⚠️ Card Generator not loaded properly!");
                }
                
                if (!window.enhancedGameModes) {
                    console.error("⚠️ Enhanced Game Modes not loaded properly!");
                }
                
                if (!window.enhancedCardRenderer) {
                    console.error("⚠️ Enhanced Card Renderer not loaded properly!");
                }
                
                // Replace standard systems with enhanced versions if needed
                if (window.cardRenderer && window.enhancedCardRenderer) {
                    window.cardRenderer = window.enhancedCardRenderer;
                    console.log("✅ Enhanced Card Renderer activated");
                }
                
                if (window.GameModes && window.enhancedGameModes) {
                    window.GameModes = window.enhancedGameModes;
                    console.log("✅ Enhanced Game Modes activated");
                }
                
                // Check cards when in game screen
                const gameScreen = document.getElementById('game-screen');
                if (gameScreen && gameScreen.classList.contains('active')) {
                    const playerHand = document.getElementById('player-hand');
                    if (!playerHand || playerHand.children.length === 0) {
                        console.log("🃏 Forcing card generation...");
                        if (typeof forceCardGeneration === 'function') {
                            forceCardGeneration();
                        } else if (window.unoMasterFix && typeof window.unoMasterFix.generatePlayerCards === 'function') {
                            window.unoMasterFix.generatePlayerCards();
                        }
                    }
                }
                
                console.log("🎮 UNO Game - Enhanced version loaded at: 2025-04-14 14:41:01");
            }, 1000);
            
            // Update game modes display in the UI
            setTimeout(updateGameModesDisplay, 500);
        });
        
        // Function to update game modes display in the UI
        function updateGameModesDisplay() {
            // Add new game modes to UI
            const modesContainer = document.querySelector('.modes-container');
            if (modesContainer && window.enhancedGameModes) {
                const newModes = ['insane', 'mirror', 'quickDraw', 'challenge'];
                
                newModes.forEach(mode => {
                    const modeInfo = window.enhancedGameModes.getMode(mode);
                    if (modeInfo) {
                        const modeCard = document.createElement('div');
                        modeCard.className = 'mode-card';
                        modeCard.dataset.mode = mode;
                        
                        modeCard.innerHTML = `
                            <div class="mode-icon">${mode.charAt(0).toUpperCase()}</div>
                            <h4>${modeInfo.name}</h4>
                            <p>${modeInfo.description.substring(0, 30)}...</p>
                        `;
                        
                        modeCard.addEventListener('click', function() {
                            // Remove selected class from all mode cards
                            document.querySelectorAll('.mode-card').forEach(card => {
                                card.classList.remove('selected');
                            });
                            
                            // Add selected class to clicked card
                            this.classList.add('selected');
                            
                            // Update mode description
                            const modeDescription = document.getElementById('mode-description');
                            if (modeDescription) {
                                modeDescription.textContent = modeInfo.description;
                                modeDescription.classList.add('highlight');
                                
                                setTimeout(() => {
                                    modeDescription.classList.remove('highlight');
                                }, 1000);
                            }
                        });
                        
                        modesContainer.appendChild(modeCard);
                    }
                });
                
                console.log("✅ Game modes UI updated with new modes");
            }
            
            // Do the same for online room modes
            const roomModeSelect = document.getElementById('room-mode');
            if (roomModeSelect && window.enhancedGameModes) {
                const newModes = ['insane', 'mirror', 'quickDraw', 'challenge'];
                
                newModes.forEach(mode => {
                    const modeInfo = window.enhancedGameModes.getMode(mode);
                    if (modeInfo) {
                        const option = document.createElement('option');
                        option.value = mode;
                        option.textContent = `${modeInfo.name} - ${modeInfo.description.substring(0, 30)}...`;
                        roomModeSelect.appendChild(option);
                    }
                });
            }
        }
    </script>
    
    <style>
        /* Styles for the start game button with pulsation */
        .pulse-button {
            position: relative;
            overflow: hidden;
        }
        
        .pulse-button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }
        
        .pulse-button.pulse::after {
            animation: pulse-shine 1s forwards;
        }
        
        @keyframes pulse-shine {
            0% { transform: translateX(-100%) rotate(45deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateX(100%) rotate(45deg); opacity: 0; }
        }
        
        /* Highlight game modes */
        .mode-card {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin: 10px;
            width: 120px;
        }
        
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .mode-card.selected {
            background-color: #e8f4fe;
            border: 2px solid #2196F3;
            transform: translateY(-5px);
        }
        
        /* Enhanced sparkle effect for legendary cards */
        @keyframes legendary-sparkle {
            0% { 
                box-shadow: 0 0 20px 5px rgba(255, 215, 0, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 30px 8px rgba(255, 215, 0, 0.8);
                transform: scale(1.02);
            }
            100% { 
                box-shadow: 0 0 20px 5px rgba(255, 215, 0, 0.6);
                transform: scale(1);
            }
        }
        
        .legendary-card {
            animation: legendary-sparkle 2s infinite;
        }
    </style>
    
    <!-- Emergency fixes -->
    <script>
    console.log("🔄 Complete load, checking final state...");
    setTimeout(function() {
        // Check Firebase
        if (typeof firebase === 'undefined' || typeof FirebaseUtil === 'undefined') {
            console.error("❌ Firebase still not available after final check!");
            
            // Create FirebaseUtil object as fallback
            window.FirebaseUtil = {
                generateRoomCode: function() {
                    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    let code = '';
                    for (let i = 0; i < 4; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    return code;
                },
                
                getRoomRef: function(roomCode) {
                    return firebase ? firebase.database().ref(`rooms/${roomCode}`) : null;
                },
                
                checkRoomExists: async function(roomCode) {
                    try {
                        if (!firebase) return false;
                        const snapshot = await firebase.database().ref(`rooms/${roomCode}`).once('value');
                        return snapshot.exists();
                    } catch (error) {
                        console.error("Error checking room:", error);
                        return false;
                    }
                },
                
                getServerTimestamp: function() {
                    return firebase && firebase.database ? firebase.database.ServerValue.TIMESTAMP : Date.now();
                }
            };
        }
        
        // Check for enhanced card systems
        if (window.gameInitializer && window.cardGenerator) {
            // Patch the createAndShuffleDeck method with the new card generator
            const originalCreateDeck = window.gameInitializer.createAndShuffleDeck;
            window.gameInitializer.createAndShuffleDeck = function(gameMode) {
                console.log("🃏 Using enhanced card generator for mode:", gameMode);
                
                // Create cards using the enhanced generator
                const cards = window.cardGenerator.createDeck(gameMode, true);
                
                // Return in the format expected by the game
                return {
                    cards: cards,
                    drawCard: function() {
                        return this.cards.pop();
                    },
                    addCard: function(card) {
                        this.cards.unshift(card);
                    },
                    cardsLeft: function() {
                        return this.cards.length;
                    }
                };
            };
            
            console.log("✅ Enhanced card generation system activated");
        }
        
        // Check cards when in game screen
        const gameScreen = document.getElementById('game-screen');
        if (gameScreen && gameScreen.classList.contains('active')) {
            const playerHand = document.getElementById('player-hand');
            if (!playerHand || playerHand.children.length === 0) {
                console.log("🃏 Final check: manually generating cards");
                
                // Emergency function to generate cards
                function emergencyCardGeneration() {
                    const playerHand = document.getElementById('player-hand');
                    if (!playerHand) return;
                    
                    // Clear current hand
                    playerHand.innerHTML = '';
                    
                    // Colors and values
                    const colors = ['red', 'blue', 'green', 'yellow'];
                    const values = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'skip', 'reverse', 'draw2'];
                    
                    // Generate 7 cards
                    for (let i = 0; i < 7; i++) {
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        const value = values[Math.floor(Math.random() * values.length)];
                        
                        // Create card
                        const card = document.createElement('div');
                        card.className = `card ${color}`;
                        card.dataset.id = `emergency-${i}-${Date.now()}`;
                        card.dataset.color = color;
                        card.dataset.value = value;
                        card.dataset.type = isNaN(value) ? 'action' : 'number';
                        
                        // Create card inner content
                        card.innerHTML = `
                            <div class="card-inner">
                                <div class="card-corners">
                                    <div class="card-corner top-left">${value}</div>
                                    <div class="card-corner bottom-right">${value}</div>
                                </div>
                                <div class="card-center">${value}</div>
                                <div class="card-reflection"></div>
                            </div>
                        `;
                        
                        // Maybe add a legendary card with very low chance
                        if (Math.random() < 0.0000001) {
                            const legendaryCard = document.createElement('div');
                            legendaryCard.className = 'card gold legendary-card';
                            legendaryCard.dataset.id = `legendary-99-${Date.now()}`;
                            legendaryCard.dataset.color = 'gold';
                            legendaryCard.dataset.value = '99';
                            legendaryCard.dataset.type = 'legendary';
                            legendaryCard.dataset.rarity = 'legendary';
                            
                            legendaryCard.innerHTML = `
                                <div class="card-inner">
                                    <div class="legendary-glow"></div>
                                    <div class="card-corners">
                                        <div class="card-corner top-left">99</div>
                                        <div class="card-corner bottom-right">99</div>
                                    </div>
                                    <div class="card-center legendary-symbol">99</div>
                                    <div class="rarity-indicator">LENDÁRIA</div>
                                    <div class="legendary-description">Carta lendária que garante uma vitória instantânea.</div>
                                    <div class="card-reflection legendary-reflection"></div>
                                </div>
                            `;
                            
                            playerHand.appendChild(legendaryCard);
                        } else {
                            playerHand.appendChild(card);
                        }
                    }
                    
                    // Update counter
                    const cardCounter = document.getElementById('card-count');
                    if (cardCounter) {
                        cardCounter.textContent = '7 cartas';
                    }
                }
                
                emergencyCardGeneration();
            }
        }
        
        console.log("✅ Final check completed at: 2025-04-14 14:41:01");
    }, 3000);
    </script>
</body>
</html>